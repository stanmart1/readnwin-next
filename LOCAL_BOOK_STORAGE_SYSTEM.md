# üìö Local Book Storage System

## üéØ **Overview**

This document outlines the new local book storage system that stores books in `/app/media_root/` on the remote server instead of in the database. This provides better performance, scalability, and easier file management.

## üìÅ **Storage Structure**

### **Directory Layout**
```
/app/media_root/
‚îú‚îÄ‚îÄ books/
‚îÇ   ‚îú‚îÄ‚îÄ [bookId]/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ original.epub          # Original uploaded file
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cover.jpg              # Cover image (if stored locally)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ metadata.json          # Extracted metadata (optional)
‚îÇ   ‚îî‚îÄ‚îÄ temp/                      # Temporary upload directory
‚îú‚îÄ‚îÄ public/
‚îÇ   ‚îî‚îÄ‚îÄ uploads/
‚îÇ       ‚îî‚îÄ‚îÄ covers/                # Web-accessible cover images
‚îî‚îÄ‚îÄ processed/                     # Processed content (if needed)
```

### **File Organization**
- **Book Files**: `/app/media_root/books/[bookId]/[filename]`
- **Cover Images**: `/app/media_root/public/uploads/covers/[filename]`
- **Temporary Files**: `/app/media_root/books/temp/[filename]`

## üîß **Implementation Details**

### **1. File Upload Service (`EnhancedFileUploadService`)**

#### **Key Changes**
- **Storage Path**: Now uses `/app/media_root/books/[bookId]/` structure
- **Book-Specific Directories**: Each book gets its own directory
- **Relative Paths**: Database stores relative paths for portability

#### **Upload Process**
1. **Validation**: File type and size validation
2. **Directory Creation**: Creates book-specific directory
3. **File Storage**: Stores file with secure filename
4. **Database Update**: Updates book record with new file path
5. **Content Parsing**: Queues book for content extraction

#### **File Path Generation**
```typescript
// Book files
relativePath = `/media_root/books/${bookId}/${secureFilename}`;

// Cover images  
relativePath = `/media_root/public/uploads/covers/${secureFilename}`;
```

### **2. File Serving API (`/api/book-files/[...path]`)**

#### **Path Resolution**
- **New Structure**: `books/[bookId]/[filename]`
- **Public Uploads**: `public/uploads/covers/[filename]`
- **Legacy Support**: Backward compatibility with old paths

#### **Security Features**
- **Path Validation**: Prevents directory traversal attacks
- **Access Control**: User authentication and authorization
- **File Type Validation**: Proper MIME type detection

### **3. E-Reader Integration**

#### **Content Loading**
- **EPUB Parsing**: Reads from local files in new structure
- **Content API**: `/api/books/[bookId]/content` serves parsed content
- **File Access**: Direct access to book files via `/api/book-files/`

#### **Reading Flow**
1. **User Access**: User opens book from library
2. **Content Request**: E-reader requests book content
3. **File Resolution**: API resolves file path to new structure
4. **Content Parsing**: EPUB/HTML content is parsed and served
5. **Reading Experience**: User reads book in e-reader interface

## üöÄ **Migration Process**

### **Migration Script**
The migration script (`scripts/migrate-book-storage.js`) handles:

1. **Directory Creation**: Sets up new storage structure
2. **File Migration**: Moves existing files to new locations
3. **Database Updates**: Updates file paths in database
4. **Cleanup**: Optionally removes old files

### **Manual Migration Steps**
```bash
# 1. Create new directory structure
mkdir -p /app/media_root/books
mkdir -p /app/media_root/public/uploads/covers
mkdir -p /app/media_root/books/temp

# 2. Run migration script
node scripts/migrate-book-storage.js

# 3. Update database paths (if needed)
# Run SQL updates generated by migration script
```

## üìä **Database Schema**

### **Updated Fields**
```sql
-- books table
ALTER TABLE books 
ADD COLUMN IF NOT EXISTS file_path TEXT, -- New local file path
ADD COLUMN IF NOT EXISTS file_size BIGINT,
ADD COLUMN IF NOT EXISTS file_hash VARCHAR(64);

-- Update existing records
UPDATE books 
SET ebook_file_url = REPLACE(ebook_file_url, '/book-files/', '/media_root/books/')
WHERE ebook_file_url LIKE '/book-files/%';
```

### **File Information Storage**
```sql
-- book_files table (for detailed file tracking)
CREATE TABLE IF NOT EXISTS book_files (
    id SERIAL PRIMARY KEY,
    book_id INTEGER REFERENCES books(id) ON DELETE CASCADE,
    file_type VARCHAR(20) NOT NULL,
    original_filename VARCHAR(255) NOT NULL,
    stored_filename VARCHAR(255) NOT NULL,
    file_path VARCHAR(500) NOT NULL,
    file_size BIGINT NOT NULL,
    mime_type VARCHAR(100),
    file_hash VARCHAR(64),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## üîç **API Endpoints**

### **File Serving**
- **GET** `/api/book-files/books/[bookId]/[filename]` - Serve book files
- **GET** `/api/book-files/public/uploads/covers/[filename]` - Serve cover images
- **HEAD** `/api/book-files/...` - Get file metadata

### **Book Content**
- **GET** `/api/books/[bookId]/content` - Get parsed book content
- **POST** `/api/books/[bookId]/epub-content` - Parse EPUB content

### **Admin Management**
- **POST** `/api/admin/books` - Upload new book with files
- **GET** `/api/admin/books` - List books with file information

## üõ°Ô∏è **Security Considerations**

### **File Access Control**
- **Authentication**: All file access requires user authentication
- **Authorization**: Users can only access books in their library
- **Path Validation**: Prevents directory traversal attacks
- **File Type Validation**: Only allows approved file types

### **File Integrity**
- **Hash Verification**: SHA-256 hashes for file integrity
- **Duplicate Detection**: Prevents duplicate file uploads
- **Size Limits**: Enforced file size restrictions

## üìà **Performance Benefits**

### **Storage Efficiency**
- **Reduced Database Size**: Large files no longer stored in database
- **Faster Queries**: Database queries are faster without BLOB data
- **Better Backup**: File system backups are more efficient

### **Access Performance**
- **Direct File Access**: No database overhead for file serving
- **Caching**: File system caching improves read performance
- **Range Requests**: Support for partial file downloads

## üîß **Configuration**

### **Environment Variables**
```bash
# Production
NODE_ENV=production
MEDIA_ROOT=/app/media_root

# Development  
NODE_ENV=development
MEDIA_ROOT=./media_root
```

### **File Permissions**
```bash
# Ensure proper permissions on media root
chmod 755 /app/media_root
chmod 755 /app/media_root/books
chmod 755 /app/media_root/public/uploads/covers
```

## üß™ **Testing**

### **Upload Testing**
```bash
# Test file upload
curl -X POST /api/admin/books \
  -F "title=Test Book" \
  -F "ebook_file=@test.epub" \
  -F "cover_image=@cover.jpg"
```

### **File Access Testing**
```bash
# Test file serving
curl -I /api/book-files/books/123/original.epub

# Test cover image access
curl -I /api/book-files/public/uploads/covers/cover.jpg
```

## üö® **Troubleshooting**

### **Common Issues**

#### **File Not Found**
- **Check Path**: Verify file exists in new storage structure
- **Permissions**: Ensure proper file permissions
- **Migration**: Run migration script if files not moved

#### **Upload Failures**
- **Directory Creation**: Check if directories exist
- **Disk Space**: Verify sufficient disk space
- **File Permissions**: Check write permissions

#### **E-Reader Issues**
- **File Path**: Verify correct file path in database
- **Content Parsing**: Check if book content was parsed
- **Access Control**: Ensure user has access to book

### **Debug Commands**
```bash
# Check directory structure
ls -la /app/media_root/books/

# Check file permissions
ls -la /app/media_root/books/[bookId]/

# Check database paths
psql -c "SELECT id, title, ebook_file_url FROM books WHERE ebook_file_url IS NOT NULL;"
```

## üìã **Deployment Checklist**

### **Pre-Deployment**
- [ ] Create new directory structure
- [ ] Set proper file permissions
- [ ] Backup existing files
- [ ] Test migration script

### **Deployment**
- [ ] Deploy updated code
- [ ] Run migration script
- [ ] Update database paths
- [ ] Test file uploads
- [ ] Test e-reader functionality

### **Post-Deployment**
- [ ] Monitor file access logs
- [ ] Verify upload functionality
- [ ] Test user library access
- [ ] Clean up old files (optional)

## üîÑ **Future Enhancements**

### **Planned Features**
- **CDN Integration**: Serve files from CDN for better performance
- **File Compression**: Compress large files for storage efficiency
- **Version Control**: Track file versions and changes
- **Bulk Operations**: Batch file operations for efficiency

### **Scalability**
- **Distributed Storage**: Support for multiple storage locations
- **Load Balancing**: Distribute file serving across servers
- **Caching Layer**: Implement file caching for better performance

---

**Last Updated**: December 2024  
**Version**: 1.0.0  
**Maintainer**: Development Team
